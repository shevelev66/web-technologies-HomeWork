<!DOCTYPE HTML>
<html>
<head>
<title>Игра Жизнь!</title>
<!-- Начало сценария -->
<script type="text/javascript">
   // Переменная для записи идентификатора процесса,
   // запускаемого с помощью функции setInterval():
   var timerID;
   // Количество клеток по горизонтали и вертикали:
   var Nx=200,Ny=100;
   // Размер клетки (в пикселях):
   var dz=3;
   // Переменная для записи ссылки
   // на раскрывающийся список:
   var list;
   // Переменные для записи ссылок на кнопки:
   var start,conf;
   // Два названия для одной из кнопок:
   var nameA="Начать игру!";
   var nameB="Остановить!";
   // Переменные для записи ссылок на объект графической
   // области и объект графического контекста:
   var cnv,ctx;
   // Переменная для записи ссылки на массив, через который
   // реализуется конфигурация клеток:
   var A;
   //переменная для задания пользователем начального состояния
   var imageData;
   //переменная для обработки пикселей для задания пользователем начального состояния
   var pixel
   // Функция для определения начального распределения
   // живых и мертвых клеток:
   function init(B){
      // Локальные переменные:
      var i,j,p;
      // Вероятность того, что клетка живая:
      p=list.value;
      // Перебор строк массива:
      for(i=0;i<B.length;i++){
         // Перебор элементов в строке:
         for(j=0;j<B[i].length;j++){
            // Если случайное число меньше вероятности:
            if(Math.random()<p){
               // Живая клетка:
               B[i][j]=1;
            }
            // Если случайное число не меньше вероятности:
            else{
               // Мертвая клетка:
               B[i][j]=0;
            }
         }
      }
   }
   // заполнение массива по нарисованному пользователем состоянию
   function initshow(B){
      // Перебор строк массива:
      for(var i=0;i<B.length;i++){
         // Перебор элементов в строке:
         for(var j=0;j<B[i].length;j++){
		    // если цвет синий, то присвоение 1 массиву - живые клетки 
			//проверка области, нарисованной пользователем
		    imageData = ctx.getImageData(dz*j, dz*i, dz, dz);
			pixel = imageData.data;			
            if(pixel[0]==0 && pixel[1]==0 && pixel[2]==255){ 
               B[i][j]=1;               
            } 
			else{
               // Мертвая клетка:
               B[i][j]=0;
            }            
         }
      }	  
   }
   //
   // Функция для подсчета живых клеток, являющихся
   // соседними для заданной клетки:
   function getState(B,i,j){
      // Локальные переменные:
      var im,ip,jm,jp,r;
      // Если клетка не в первой строке:
      if(i>0){
         // Первый индекс для соседней клетки сверху:
         im=i-1;
      }
      // Если клетка в первой строке:
      else{
         // Первый индекс для соседней клетки "сверху":
         im=B.length-1;
      }
      // Если клетка не в последней строке:
      if(i<B.length-1){
         // Первый индекс для соседней клетки снизу:
         ip=i+1;
      }
      // Если клетка в последней строке:
      else{
         // Первый индекс для соседней клетки "снизу":
         ip=0;
      }
      // Если клетка не в первом столбце:
      if(j>0){
         // Второй индекс для соседней клетки слева:
         jm=j-1;
      }
      // Если клетка в первом столбце:
      else{
         // Второй индекс для соседней клетки "слева":
         jm=B[i].length-1;
      }
      // Если клетка не в последнем столбце:
      if(j<B[i].length-1){
         // Второй индекс для соседней клетки справа:
         jp=j+1;
      }
      // Если клетка в последнем столбце:
      else{
         // Второй индекс для соседней клетки "справа":
         jp=0;
      }
      // Вычисление количества живых соседних клеток:
      r=B[i][jm]+B[i][jp]+B[im][j]+B[ip][j]+B[im][jm]+B[ip][jp]+B[im][jp]+B[ip][jm]
      // Результат функции:
      return r
   }
   // Функция для вычисления новой конфигурации
   // (нового поколения клеток):
   function recalc(B){
      // Локальная переменная:
      var nbs;
      // Локальный массив для записи новой конфигурации:
      var C=new Array(B.length);
      // Перебор элементов локального массива:
      for(var i=0;i<C.length;i++){
         // Создание новой строки:
         C[i]=new Array(B[i].length);
         // Перебор элементов в строке:
         for(var j=0;j<C[i].length;j++){
            // Количество живых соседних клеток для
            // исходной конфигурации:
            nbs=getState(B,i,j);
            // Если текущая клетка в исходной
            // конфигурации мертвая:
            if(B[i][j]==0){
               // Если ровно три живых соседних клетки:
               if(nbs==3){
                  // В новой конфигурации клетка оживает:
                  C[i][j]=1;
               }
               // Если живых клеток не три:
               else{
                  // В новой конфигурации клетка остается
                  // мертвой:
                  C[i][j]=0;
               }
            }
            // Если текущая клетка в исходной
            // конфигурации живая:
            else{
               // Если живых соседних клеток две или три:
               if((nbs==2)||(nbs==3)){
                  // В новой конфигурации клетка остается
                  // живой:
                  C[i][j]=1;
               }
               // Если живых соседних клеток
               // не три и не две:
               else{
                  // В новой конфигурации клетка
                  // становится мертвой:
                  C[i][j]=0;
               }
            }
         }
      }
      // Результат функции:
      return C;
   }
   // Функция для отображения картинки на основе
   // конфигурации живых и мертвых клеток:
   function show(B){
      // Очистка графической области:
      ctx.clearRect(0,0,cnv.width,cnv.height);
      // Синий цвет для выполнения заливки области
      // с живыми клетками:
      ctx.fillStyle="blue";
      // Перебор строк массива:
      for(var i=0;i<B.length;i++){
         // Перебор элементов в строке:
         for(var j=0;j<B[i].length;j++){
            // Если клетка живая:
            if(B[i][j]==1){
               // Заливка области клетки цветом:
               ctx.fillRect(dz*j,dz*i,dz,dz);
            }
         }
      }
   }
   // Функция для вычисления новой конфигурации
   // и отображения картинки:
   function showNext(){
      // Новая конфигурация:
      A=recalc(A);
      // Отображение новой картинки:
      show(A);
   }
   // Функция для вызова при генерировании начальной
   // конфигурации клеток:
   function config(){
      // Начальное распределение живых и мертвых клеток:
	  if (document.getElementById("ByRandom").checked==true) {init(A); start.disabled=false; }
	  	 
      // Отображение картинки:
      show(A);
   }
   // Обработчик события, связанного с загрузкой документа:
   window.onload=function(){
      // Получение ссылки на объект графической области:
      cnv=document.getElementById("mycanvas");
      // Ширина графической области:
      cnv.width=Nx*dz;
      // Высота графической области:
      cnv.height=Ny*dz;
	  // Ширина формы с элементами управления:
      document.getElementById("myform").style.width=cnv.width-10+"px";
      // Получение ссылки на объект графического контекста:
      ctx=cnv.getContext("2d");
      // Получение ссылки на объект кнопки выбора
      // начальной конфигурации живых и мертвых клеток:
      conf=document.getElementById("conf");
      // Кнопка выбора конфигурации в активном состоянии:
      conf.disabled=false;
      // Получение ссылки на объект кнопки, используемой
      // для запуска и остановки вычислений:
      start=document.getElementById("start");
      // Название для кнопки запуска вычислений:
      start.value=nameA;
      // Получение ссылки на объект раскрывающегося списка:
      list=document.getElementById("prob");
      // Список в активном состоянии:
      list.disabled=false;
	  // при загрузке состояние кнопок
	  prob.disabled=true;
	  conf.disabled=true;
	  setstatus.disabled=false;
	  clrstatus.disabled=false;
	  start.disabled=true
      // Индекс выбранного в списке пункта:
      var index=1;
      // Выбор пункта в раскрывающемся списке:
      list.selectedIndex=index;
	  // Массив для реализации конфигурации клеток:
      A=new Array(Ny);
      // Создание каждой отдельной строки:
      for(var k=0;k<A.length;k++){
         // Новая строка:
         A[k]=new Array(Nx);
      }
      // Начальная конфигурация:
      config();
      // Обработчик щелчка на кнопке задания конфигурации:
      conf.onclick=config;
	  // обработчик клика на кнопке задания состояния пользователем
	  setstatus.onclick=function(){
	     initshow(A);
		 start.disabled=false;
	  }
	  // Обработчик щелчка на кнопке очистки поля:
	  clrstatus.onclick=function(){
	     ctx.clearRect(0,0,cnv.width,cnv.height);
		 start.disabled=true;
	  }
	  // обработчик клика на выборе режима "рисования"
	  ByUser.onclick=function(){
	     prob.disabled=true;
		 conf.disabled=true;
		 setstatus.disabled=false;
		 clrstatus.disabled=false;
	  }
	  // Изменение размеров игрового поля
	  updatepole.onclick=function(){
	    // считываем данные с формы
	     Nx=document.getElementById("canx").value;
		 Ny=document.getElementById("cany").value;
		 // Ширина графической области:
         cnv.width=Nx*dz;
         // Высота графической области:
         cnv.height=Ny*dz;
		 // Обновляем массив для реализации новой конфигурации клеток:
         A.length=Ny;
		 // Обновление каждой отдельной строки:
         for(var k=0;k<A.length;k++){
		 // Новая строка:
		 // при увеличении строк создаем новуе массивы
		 if (A[k]==undefined) {A[k]=new Array(Nx);}
		 // задаем новую длину
		 A[k].length=Nx;
		 }		 
	  }
	  // обработчик клика на выборе режима Randoma
	  ByRandom.onclick=function(){
	     prob.disabled=false;
		 conf.disabled=false;
		 setstatus.disabled=true;
		 clrstatus.disabled=true;
	  }
	  // Обработчик для события, связанного с изменением
      // состояния раскрывающегося списка:
      list.onchange=conf.onclick;
      // Обработчик события, связанного со щелчком
      // на кнопке запуска/остановки вычислений:
      start.onclick=function(){
         // Если у кнопки первое название:
         if(this.value==nameA){
            // Блокировка раскрывающегося списка:
            list.disabled=true;
            // Блокировка кнопки выбора конфигурации:
			if (document.getElementById("ByRandom").checked==true) { conf.disabled=true }            
            // Изменение называния кнопки:
            this.value=nameB;
            // Запуск процесса вычислений в мс:
			var speedgame=document.getElementById("speed").value;
			if (speedgame<1) {speedgame=100}
			timerID=setInterval(showNext,speedgame);
			speed.disabled=true;
			canx.disabled=true;
			cany.disabled=true;
			updatepole.disabled=true;
         }
         // Если у кнопки другое название:
         else{
            // Отмена блокировки раскрывающегося списка:
            list.disabled=false;
            // Отмена блокировки кнопки
            // выбора конфигурации:
			if (document.getElementById("ByRandom").checked==true) { conf.disabled=false }
            // Изменение названия кнопки:
            this.value=nameA;
            // Остановка процесса вычислений:
            clearInterval(timerID);
			speed.disabled=false;
			canx.disabled=false;
			cany.disabled=false;
			updatepole.disabled=false;
         }
      }
   }
   
</script>
<!-- Завершение сценария -->
<!-- Описание стилей -->
<style type="text/css">
   /* Стиль для формы myform */
   #myform{
      height: 320px;
      border-style: outset; 
      padding: 5px;
      background-color: #f0f0f0;
      font-size: 17px;
   }
   /* Стиль для кнопок формы myform */
   #myform input[type="button"]{
      font-weight: bold;
      height: 30px;
   }
   /* Стиль для раскрывающегося списка формы myform */
   #myform select{
      height: 30px;
      border-color: silver;
      font-weight: bold;
   }
</style>
<!-- Завершение описания стилей -->
</head>
<body>
   <h3>"Игра Жизнь!"</h3><hr>
   <!-- Форма с элементами управления -->
   <form id="myform">
      <!-- Текст -->
	  <!-- Радиокнопки для задания пользовательского состояния -->
	  <b>Задание начального состояния:</b><br>
      <input type="radio" name="status"  id="ByUser" checked>"Нарисовать" мышью<br>
      <input type="radio" name="status"  id="ByRandom">Генератором случайных чисел на основе вероятности<br><hr>
      
	  <label>Размер игрового поля:</label><br>
	  <label>Ширина:</label>
	  <input type="text" id="canx" style="width:50px;" value="200">
	  <label>Высота:</label>
	  <input type="text" id="cany" style="width:50px;" value="100">
	   <input type="button" id="updatepole" style="width:150px;" value="Обновить поле">
	  <br><hr>	  
	  <b>"Нарисованное" пользователем:</b><br>	 
      <!-- Кнопка для задания пользовательского состояния -->
      <input type="button" id="setstatus" style="width:150px;" value="Задать состояние">
      <!-- Кнопка для задания пользовательского состояния -->
      <input type="button" id="clrstatus" style="width:150px;" value="Очистить поле"><br><hr> 	  
	  <b>Задание генератором случайныз чисел:</b><br>
      <b>Вероятность</b>
      <!-- Раскрывающийся список -->
      <select size="1" id="prob">
         <option value="0.1">0.10</option>
         <option value="0.2">0.20</option>
         <option value="0.3">0.30</option>
         <option value="0.5">0.50</option>
         <option value="0.75">0.75</option>
      </select>		
      <!-- Кнопка выбора конфигурации -->
      <input type="button" id="conf" value="Новая конфигурация"><br><hr>
      <!-- Кнопка начала и остановки вычислений -->
      <input type="button" id="start" style="width:120px;">
	  <label>Скорость игры, мс:</label>
	  <input type="text" id="speed" style="width:50px;" value="100"><br>
	  
      	  
   </form>
   <!-- Графическая область -->
   <canvas id="mycanvas" style="border:ridge;"></canvas>
   <!--скрипт рисования мышью на canvе-->
        <script>
		    var canvas = document.getElementById("mycanvas");
            var context = canvas.getContext("2d");
            var w = canvas.width;
            var h=canvas.height;				
             // координаты мшки    
            var mouse = { x:0, y:0};
			// флаг нажатия мыши
            var draw = false;             
            canvas.addEventListener("mousedown", function(e){
                 // событие мышь нажата - можно рисовать
                mouse.x = e.pageX - this.offsetLeft;
                mouse.y = e.pageY - this.offsetTop;
                draw = true;
                context.beginPath();
                context.moveTo(mouse.x, mouse.y);
            });
            canvas.addEventListener("mousemove", function(e){
                 
                if(draw==true && document.getElementById("ByUser").checked==true ){
                 // событие мышь перемещается
                    mouse.x = e.pageX - this.offsetLeft;
                    mouse.y = e.pageY - this.offsetTop;
					//чертим путь
                    context.lineTo(mouse.x, mouse.y);
					context.strokeStyle = "blue";
                    context.stroke();
                }
            });
            canvas.addEventListener("mouseup", function(e){
                 // событие мышь отпущена
			if(document.getElementById("ByUser").checked==true ){
                mouse.x = e.pageX - this.offsetLeft;
                mouse.y = e.pageY - this.offsetTop;
                context.lineTo(mouse.x, mouse.y);
                context.stroke();
                context.closePath();
                draw = false;
				}
            }); 
        </script>
		<!--скрипт-->
		<p>Краткое описание правил игры:</p>
		<ul>
    <li>Для симуляции игры используется клеточное поле.</li>
    <li>У каждой клетки есть 8 соседних клеток.</li>
    <li>Каждая клетка может находится в одном из двух состояний – либо пустая, либо в ней находится фишка.</li>
    <li>Фишка выживает (клетка остается в том же состоянии) в следующем поколении если у неё есть две или три соседние фишки.</li>
    <li>Фишка погибает (клетка опустошается) в следующем поколении, если она имеет больше, чем три (от перенаселенности) или меньше, чем два соседа (от одиночества).</li>
    <li>Фишка рождается в пустой клетке, если в соседних с ней клетках стоит ровно три фишки.</li>
        </ul>
	<p>Начальное состояние игры может задаваться 2 способами:</p>
	<ol>
    <li>пользователем методом «рисования» мышью на canvas-е.</li>
	<li>генератором случайных чисел на основе вероятности</li>
	</ol>
	<p>Нарисуйте мышью в игровом поле, а за тем нажмите кнопку "Задать состояние" и можно Начать игру!.</p>
	<p>Можно менять скорость игры и размер игрового поля.</p>

</body>
</html>